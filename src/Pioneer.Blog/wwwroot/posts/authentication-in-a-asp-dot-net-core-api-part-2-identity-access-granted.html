<!doctype html>
<html class="no-js" lang="">
<head>
  <link href="/app.css" rel="stylesheet" />
  <script src="/app.js"></script>
</head>
<body>
  <div class="row">
    <div class="large-10 large-push-1 columns">
      <article>
        <div class="note">
          <p>In this series, I am going to outline some basic approaches to authenticating your .NET Core API using either ASP.NET Core Identity or token-based authentication with a JSON Web Token (JWT).  I will also explore how to configure your application to return proper response types to both Redirect To Login and Redirect To Access Denied events when using ASP.NET Core Identity.</p>
          <h4>Authentication In A Dot Net Core API</h4>
          <ol style="margin-bottom: 0;">
            <li>
              <a href="/posts/authentication-in-a-dot-net-core-api-part-1-identity-access-denied.html" title="ASP.NET Core Identity Access Denied" target="_blank">ASP.NET Core Identity, Accessed Denied.</a>
            </li>
            <li>
              <a href="" title="ASP.NET Core Identity Access Granted" target="_blank">ASP.NET Core Identity, Accessed Granted. (Coming Soon)</a>
            </li>
            <li>
              <a href="" title="Token authentication with JWT, JSON Web Tokens" target="_blank">Token authentication with JWT, JSON Web Tokens. (Coming Soon)</a>
            </li>
          </ol>
        </div>
        <p>In part 1 (<a href="/posts/authentication-in-a-dot-net-core-api-part-1-identity-access-denied.html" title="ASP.NET Core Identity Access Denied" target="_blank">ASP.NET Core Identity, Accessed Denied</a>) of this series, I explored how to deny access to your ASP.NET Core API endpoints and return proper response types to both the Redirect To Login and Redirect To Access Denied events using ASP.NET Core Identity.  In this post I will show how to register a user with ASP.NET Core Identity and authenticate that user so that it will have access to our secure endpoints.</p>
        <h2>Registering A User</h2>
        <p>When we set up our db context to derive from a <b>IdentityDbContext</b> type and created the database through our EF migrations, we were provide with the necessary tables needed to support our Identity configuration.</p>
        <a href="/images/authentication-in-a-asp-dot-net-core-api-part-2-identity-access-granted/db-tables.jpg" target="blank" title="Database Tables">
          <img src="/images/authentication-in-a-asp-dot-net-core-api-part-2-identity-access-granted/db-tables.jpg" alt="Database Tables" style="max-width: 249px;" />
        </a>
        <p>To register a user and populate these tables with the necessary data needed to authenticate, I created the following endpoint in a new controller called <b>AccountApiController</b> located in the <b>Admin</b> area of my project.</p>
        <pre class="brush: csharp">[HttpPost]
public async Task&lt;IActionResult&gt; Create([FromBody] AccountRegister model)
{
    if (!ModelState.IsValid)
    {
        return BadRequest(ModelState.Values.SelectMany(v => v.Errors).Select(modelError => modelError.ErrorMessage).ToList());
    }

    var user = new UserEntity { UserName = model.Email, Email = model.Email };
    var result =  await _userManager.CreateAsync(user, model.Password);

    if (!result.Succeeded)
    {
        return BadRequest(result.Errors.Select(x => x.Description).ToList());
    }

    await _signInManager.SignInAsync(user, false);

    return Ok();
}</pre>
        <p>In this method we are...</p>
        <ol>
          <li>
            Checking the Model State to insure the data populating our model is valid.
            <ul>
              <li>If it is not valid, return our model validation errors.</li>
            </ul>
          </li>
          <li>Create a mapping to our <b>UserEntity</b> object.</li>
          <li>Make a asynchronous request to our <b>UserManager&lt;UserEntity&gt;</b> to create a new user record.</li>
          <li>
            Check the result for success.
            <ul>
              <li>If it is not valid, return our <b>UserManager</b> service errors.</li>
            </ul>
          </li>
          <li>Make a asynchronous request to our <b>SignInManager&lt;UserEntity&gt;</b> to sign that user in.</li>
        </ol>
        <p>That is it for registration!</p>
        <h2>Authenticating</h2>
        <p>Now that we have a user record in our tables, we can create a means in which to login that user.  At which, that user will receive the necessary cookie to validate its request to our secure endpoints.  To accomlish this, </p>
        <p>None that we have effectively denied access to our route, we need a way to grant access.  To do this with Identity, we need to create a account the <b>Microsoft.AspNetCore.Identity.UserManager&lt;UserEntity&gt;</b> class.  I accomplished in my <b>AccountController</b> with the following code.</p>
      </article>
    </div>
  </div>
</body>
</html>