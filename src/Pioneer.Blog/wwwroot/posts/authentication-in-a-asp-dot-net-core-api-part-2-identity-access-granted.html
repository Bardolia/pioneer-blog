<!doctype html>
<html class="no-js" lang="">
<head>
  <link href="/app.css" rel="stylesheet" />
  <script src="/app.js"></script>
</head>
<body>
  <div class="row">
    <div class="large-10 large-push-1 columns">
      <article>
        <div class="note">
          <p>In this series, I am going to outline some basic approaches to authenticating your .NET Core API using either ASP.NET Core Identity or token-based authentication with a JSON Web Token (JWT).  I will also explore how to configure your application to return proper response types to both Redirect To Login and Redirect To Access Denied events when using ASP.NET Core Identity.</p>
          <h4>Authentication In A Dot Net Core API</h4>
          <ol style="margin-bottom: 0;">
            <li>
              <a href="/posts/authentication-in-a-dot-net-core-api-part-1-identity-access-denied.html" title="ASP.NET Core Identity Access Denied" target="_blank">ASP.NET Core Identity, Accessed Denied.</a>
            </li>
            <li>
              <a href="" title="ASP.NET Core Identity Access Granted" target="_blank">ASP.NET Core Identity, Accessed Granted. (Coming Soon)</a>
            </li>
            <li>
              <a href="" title="Token authentication with JWT, JSON Web Tokens" target="_blank">Token authentication with JWT, JSON Web Tokens. (Coming Soon)</a>
            </li>
          </ol>
        </div>
        <p>In part 1 (<a href="/posts/authentication-in-a-dot-net-core-api-part-1-identity-access-denied.html" title="ASP.NET Core Identity Access Denied" target="_blank">ASP.NET Core Identity, Accessed Denied</a>) of this series, I explored how to deny access to your ASP.NET Core API endpoints and return proper response types to both the Redirect To Login and Redirect To Access Denied events using ASP.NET Core Identity.  In this post I will show how to register a user with ASP.NET Core Identity and authenticate that user so that it will have access to our secure endpoints.</p>
        <h2>Registering A User</h2>
        <p>When we set up our db context to derive from a <b>IdentityDbContext</b> type and created the database through our EF migrations, we were provide with the necessary tables needed to support our Identity configuration.</p>
        <a href="/images/authentication-in-a-asp-dot-net-core-api-part-2-identity-access-granted/db-tables.jpg" target="blank" title="Database Tables">
          <img src="/images/authentication-in-a-asp-dot-net-core-api-part-2-identity-access-granted/db-tables.jpg" alt="Database Tables" style="max-width: 249px;" />
        </a>
        <p></p>
        
        

        <h2>Authenticating</h2>
        <p>None that we have effectively denied access to our route, we need a way to grant access.  To do this with Identity, we need to create a account the <b>Microsoft.AspNetCore.Identity.UserManager&lt;UserEntity&gt;</b> class.  I accomplished in my <b>AccountController</b> with the following code.</p>

        <pre class="brush: csharp">[HttpPost]
[AllowAnonymous]
[ValidateAntiForgeryToken]
public async Task&lt;IActionResult&gt; Register(RegisterViewModel model, string returnUrl = null)
{
    ViewData[&quot;ReturnUrl&quot;] = returnUrl;

    if (!ModelState.IsValid) return View(model);

    var user = new UserEntity { UserName = model.Email, Email = model.Email };
    var result = await _userManager.CreateAsync(user, model.Password);
    if (result.Succeeded)
    {
        await _signInManager.SignInAsync(user, false);
        return RedirectToLocal(returnUrl);
    }

    AddErrors(result);

    // If we got this far, something failed, redisplay form
    return View(model);
}</pre>
        <p>In short, a POST request is preformed against this route with the necessary information in its payload needed to create a new account.  Supporting functionality such as logging a user in, is also illustrated in the <b>AccountController</b> of this project.  I encourage you to take a look at the latest version of this controller in the <a href="https://github.com/PioneerCode/pioneer-blog">Pioneer Code Blog</a> repository.</p>
        <p>Once we have an account setup with Identity, we need to login to get the necessary cookie payload used to pass authentication with Identity. </p>
      </article>
    </div>
  </div>
</body>
</html>